# Feature Specification: 電費計價日期選擇與歷史紀錄時間欄位

**Feature Branch**: `003-`
**Created**: 2025-10-09
**Status**: Draft
**Input**: User description: "新增日期選擇功能以判定夏月/非夏月電價，並在歷史紀錄中加入用電日期與創建時間欄位"

## Clarifications

### Session 2025-10-09

- Q: 日期選擇器應該如何整合到現有的計算表單中？ → A: 在表單最上方新增日期選擇器，保留原有欄位但設為唯讀顯示判定結果
- Q: 當使用者首次開啟歷史紀錄頁面時，預設應該依哪個時間欄位排序？ → A: 依「創建時間」由近到遠（最新建立的紀錄在上）
- Q: 統計摘要應該在何時顯示？ → A: 無論是否篩選，永遠顯示當前可見紀錄的統計摘要（包括顯示全部紀錄時）
- Q: 使用者如何快速篩選「夏月」或「非夏月」的所有紀錄？ → A: 使用者必須手動輸入日期範圍來篩選，不提供快速篩選
- Q: 創建時間應該使用什麼時間來源？ → A: 使用使用者裝置的本地時間（接受可能的時間誤差）
- Q: 當電費帳單的計費期間橫跨夏月與非夏月時，系統應如何處理？ → A: 顯示警告訊息建議拆分（以確保計價準確性），但仍允許使用者確認後儲存；計價季節以期間內天數較多的季節為準

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 選擇電費計費期間自動判定計價季節 (Priority: P1)

農民希望輸入電費帳單的實際計費期間（開始與結束日期），系統自動判定該期間屬於夏月或非夏月計價，避免手動選擇計價季節時產生錯誤，確保用電成本估算的準確性。若計費期間橫跨兩個季節，系統會顯示警告提醒拆分。

**Why this priority**: 這是核心功能改進，直接影響計算準確性。自動判定計價季節可減少使用者錯誤，提升資料可靠度。使用計費期間而非單一日期更符合台電實際帳單格式。

**Independent Test**: 可透過選擇不同月份的計費期間（例如 7/1-7/31 與 12/1-12/31），驗證系統是否正確自動判定為夏月或非夏月計價，並反映在計算結果中。此功能獨立於歷史紀錄功能，可單獨測試與部署。

**Acceptance Scenarios**:

1. **Given** 農民需要計算 7 月份的用電成本，**When** 選擇計費期間為 2024/07/01 - 2024/07/31，**Then** 系統自動判定為「夏月」計價，並顯示對應的台電夏月費率級距
2. **Given** 農民需要計算 11 月份的用電成本，**When** 選擇計費期間為 2024/11/01 - 2024/11/30，**Then** 系統自動判定為「非夏月」計價，並顯示對應的台電非夏月費率級距
3. **Given** 農民選擇了計費期間，**When** 系統判定計價季節後，**Then** 原本的「夏月/非夏月」手動選擇欄位顯示為唯讀狀態並自動填入判定結果，防止手動修改造成不一致
4. **Given** 農民未完整選擇計費期間（缺少開始或結束日期），**When** 嘗試進行計算，**Then** 系統提示「請完整選擇電費計費期間（開始與結束日期）」並阻止計算
5. **Given** 農民選擇橫跨季節邊界的計費期間（例如 2024/05/15 - 2024/06/14），**When** 系統判定計價季節，**Then** 系統以天數較多的季節為準（此例為非夏月 17 天 vs 夏月 14 天，判定為「非夏月」），並顯示黃色警告「您的計費期間橫跨夏月與非夏月，建議拆分為兩筆紀錄以確保計價準確性」
6. **Given** 農民選擇結束日期早於開始日期（例如 2024/07/31 - 2024/07/01），**When** 嘗試進行計算，**Then** 系統顯示錯誤訊息「結束日期必須晚於開始日期」並阻止計算

---

### User Story 2 - 歷史紀錄顯示計費期間與創建時間 (Priority: P2)

農民查看歷史紀錄時，需要清楚區分「實際電費帳單的計費期間」與「建立該筆紀錄的時間」，以便追蹤不同帳單期間的用水估算，並了解資料輸入的時序。

**Why this priority**: 提升歷史資料的可追溯性與管理價值。區分計費期間與創建時間讓農民能更精確地分析不同帳單期間的用水模式，同時保留資料建立的完整脈絡。

**Independent Test**: 可透過建立多筆不同「計費期間」的紀錄（例如選擇去年同期的期間進行比較），然後檢視歷史紀錄表格，驗證時間欄位是否正確顯示且可排序。此功能依賴 P1 的日期選擇功能，但可獨立測試顯示邏輯。

**Acceptance Scenarios**:

1. **Given** 農民完成一筆用電計算（選擇計費期間為 2024/07/01 - 2024/07/31），**When** 儲存紀錄，**Then** 歷史紀錄表格中該筆資料顯示「計費期間」為 2024/07/01 - 2024/07/31，「創建時間」為當下的實際時間（例如 2024/10/09 14:30）
2. **Given** 農民查看歷史紀錄，**When** 檢視紀錄列表，**Then** 每一筆紀錄清楚顯示「計費期間」與「創建紀錄時間」兩個欄位，且預設依「創建時間」由近到遠排序
3. **Given** 農民需要排序歷史紀錄，**When** 點擊「計費期間」欄位標題，**Then** 紀錄依計費期間起始日期由近到遠（或由遠到近）排序
4. **Given** 農民需要排序歷史紀錄，**When** 點擊「創建時間」欄位標題，**Then** 紀錄依創建時間由近到遠（或由遠到近）排序
5. **Given** 農民匯出歷史紀錄為 CSV，**When** 開啟匯出檔案，**Then** CSV 檔案包含「計費期間起」、「計費期間迄」與「創建時間」三個欄位，格式為 YYYY/MM/DD

---

### User Story 3 - 依計費期間篩選與分析歷史紀錄 (Priority: P3)

農民希望能依「計費期間起始日期」篩選歷史紀錄，快速查看特定時間範圍（例如去年同期或特定季節）的用水估算資料，進行年度比較與季節性分析。

**Why this priority**: 增強資料分析能力，讓農民能進行更深入的歷史比較。此功能建立在 P1 和 P2 之上，屬於進階分析功能。

**Independent Test**: 可透過建立多個月份的紀錄，然後使用日期範圍篩選器（例如選擇「2024 年 6-9 月」）驗證系統是否只顯示該期間的紀錄，並正確計算該期間的統計數據。

**Acceptance Scenarios**:

1. **Given** 農民有多筆不同計費期間的歷史紀錄，**When** 選擇篩選範圍「2024/06/01 - 2024/09/30」，**Then** 系統只顯示計費期間起始日期落在該範圍內的紀錄，並自動更新統計摘要顯示篩選結果的數據
2. **Given** 農民篩選出夏月期間的紀錄，**When** 查看篩選結果，**Then** 統計摘要即時更新顯示該期間的平均用水量、總用電度數與紀錄筆數
3. **Given** 農民想比較不同年度的同期資料，**When** 手動輸入跨年度的夏月日期範圍（例如 2023/06/01 - 2024/09/30），**Then** 系統顯示所有計費期間起始日期落在指定範圍內的紀錄（跨年度）
4. **Given** 農民完成篩選，**When** 點擊「清除篩選」，**Then** 系統恢復顯示所有歷史紀錄，統計摘要回復顯示全部紀錄的數據

---

### Edge Cases

- 計費期間橫跨夏月與非夏月邊界（例如 5/15-6/14）時，系統如何判定計價季節？答：以期間內天數較多的季節為準，並顯示警告訊息建議拆分
- 計費期間剛好在邊界日期（例如 5/31-6/1）時，如何判定？答：計算各季節天數，天數相等時以結束日期所屬季節為準
- 使用者選擇未來的計費期間時，系統是否允許？答：顯示非阻擋式警告，允許確認後繼續（FR-011）
- 系統如何處理跨年度的計費期間（例如 12/15-1/15）？答：正常處理，判定邏輯不受年度影響，僅依月份判定季節
- 使用者輸入異常長的計費期間（例如 90 天）時，系統如何處理？答：顯示警告「計費期間異常長（超過 70 天）」，但允許繼續（FR-005b）
- 使用者選擇結束日期早於開始日期時，系統如何處理？答：顯示錯誤訊息並阻止計算（FR-005a）
- 歷史紀錄中若有舊資料沒有「計費期間」欄位，系統如何處理？答：以「創建時間」日期作為計費期間起迄預設值（同一天），確保資料完整性（FR-012）
- 使用者在不同時區建立紀錄時，時間戳記如何統一處理？答：統一使用台灣時區 GMT+8（FR-013）
- 使用者手動調整裝置時間後建立紀錄，創建時間會反映裝置時間（可能不準確），系統是否需要顯示警告或驗證？答：接受裝置時間，不額外驗證（技術限制）

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系統必須在計算表單最上方提供日期範圍選擇器，讓使用者選擇電費帳單的計費期間（開始日期與結束日期，各包含年、月、日）
- **FR-002**: 系統必須根據選擇的計費期間判定計價季節：若整個期間落在單一季節（夏月 6/1-9/30 或非夏月 1/1-5/31、10/1-12/31）內，自動判定並套用該季節費率；若期間橫跨兩個季節，以天數較多的季節為準（天數相等時以結束日期所屬季節為準），同時顯示警告訊息但仍允許儲存
  - **季節判定邏輯**：逐日計算期間內各日期所屬季節，統計夏月與非夏月的天數，取天數較多者
  - **天數相等處理**：若夏月天數 = 非夏月天數（例如 5/31-6/1，各 1 天），以結束日期（6/1）所屬季節（夏月）為準
- **FR-002a**: 系統必須檢測計費期間是否橫跨夏月與非夏月邊界：若開始日期與結束日期屬於不同計價季節，顯示黃色警告「您的計費期間橫跨夏月與非夏月，建議拆分為兩筆紀錄以確保計價準確性」，使用者可選擇確認後繼續
- **FR-003**: 系統必須在判定計價季節後，自動套用對應的台電費率級距（夏月或非夏月）進行計算；若期間橫跨季節，以期間內天數較多的季節為準
- **FR-004**: 系統必須保留原有的「夏月/非夏月」欄位，但設為唯讀狀態顯示由計費期間自動判定的結果，防止使用者手動修改造成不一致
- **FR-005**: 系統必須在使用者未完整選擇計費期間（缺少開始或結束日期）時，顯示「請完整選擇電費計費期間（開始與結束日期）」驗證訊息，並阻止計算執行
- **FR-005a**: 系統必須驗證結束日期晚於開始日期，若不符合則顯示錯誤訊息「結束日期必須晚於開始日期」並阻止計算
- **FR-005b**: 系統必須驗證計費期間長度合理（建議 1-70 天），若超過 70 天顯示警告訊息「計費期間異常長（超過 70 天），請確認日期是否正確」，但仍允許繼續
  - **70 天限制理由**：基於台電雙月抄表制度，正常帳單計費期間約 60-62 天（兩個月）；設定 70 天上限（62 天 + 8 天緩衝）可偵測使用者可能的輸入錯誤（例如選錯年份、誤選季度範圍等），同時保留彈性允許特殊帳單週期
- **FR-006**: 系統必須在歷史紀錄中儲存計費期間（開始與結束日期）與創建時間：「計費期間起」、「計費期間迄」（使用者選擇的電費帳單計費期間）與「創建時間」（儲存紀錄的實際時間戳記）
- **FR-007**: 系統必須在歷史紀錄表格中顯示「計費期間」與「創建時間」欄位，使用以下格式：
  - **計費期間顯示格式**：「YYYY/MM/DD - YYYY/MM/DD」（例如：2024/07/01 - 2024/07/31）
  - **創建時間顯示格式**：「YYYY/MM/DD HH:mm」（例如：2024/10/09 14:30）
  - **匯出格式（CSV）**：計費期間起、計費期間迄、創建時間皆使用 YYYY/MM/DD 格式（時間部分省略）
  - **匯出格式（JSON）**：所有日期時間使用 ISO 8601 格式（例如：2024-07-01T00:00:00+08:00）
- **FR-008**: 系統必須允許使用者分別依「計費期間（起始日期）」或「創建時間」排序歷史紀錄（升冪或降冪），預設依「創建時間」降冪排序（最新建立的紀錄在上）
- **FR-009**: 系統必須提供日期範圍篩選器，讓使用者依「計費期間起始日期」篩選歷史紀錄（開始日期與結束日期）
- **FR-010**: 系統必須在使用者選擇未來日期時（計費期間起或迄任一日期），顯示非阻擋式黃色警告訊息「您選擇的計費期間包含未來日期，是否確定？」，使用者可選擇確認後繼續操作
- **FR-011**: 系統必須處理舊有歷史紀錄的資料遷移：在應用啟動時使用 `records.some(r => !r.billingPeriodStart)` 檢查是否存在舊紀錄；若紀錄缺少 `billingPeriodStart` 欄位則判定為舊紀錄，自動以「創建時間」(timestamp) 的日期作為計費期間起迄的預設值（同一天，格式 YYYY-MM-DD）
- **FR-012**: 系統必須統一使用台灣時區（GMT+8）處理所有時間戳記，避免時區差異造成的錯誤
- **FR-013**: 系統必須在日期選擇器中限制可選擇的日期範圍：最早為 2020 年 1 月 1 日（含），最晚為當下日期（今天）加 365 天（含），計算方式為 `new Date().setFullYear(new Date().getFullYear() + 1)`，確保閏年正確處理
  - **日期範圍超出錯誤訊息**：「日期必須在 2020/01/01 與 {計算的最大日期} 之間」（例如：「日期必須在 2020/01/01 與 2025/10/09 之間」）
- **FR-014**: 系統必須在歷史紀錄頁面永遠顯示當前可見紀錄的統計摘要（紀錄筆數、平均用水量、總用電度數），無論是否有進行篩選
- **FR-015**: 系統的計價季節判定以計費期間內天數較多的季節為準，不支援自動按比例拆分計算；若計費期間橫跨夏月與非夏月邊界，系統顯示警告訊息（FR-002a）建議拆分，但仍允許使用者確認後儲存紀錄

### 驗證訊息規範 _(完整列表)_

**錯誤訊息（紅色，阻擋操作）**:
- 計費期間未完整選擇：「請完整選擇電費計費期間（開始與結束日期）」（FR-005）
- 結束日期早於開始日期：「結束日期必須晚於開始日期」（FR-005a）
- 日期超出範圍：「日期必須在 2020/01/01 與 {最大日期} 之間」（FR-013）

**警告訊息（黃色，不阻擋操作）**:
- 計費期間過長：「計費期間異常長（超過 70 天），請確認日期是否正確」（FR-005b）
- 橫跨季節邊界：「您的計費期間橫跨夏月與非夏月，建議拆分為兩筆紀錄以確保計價準確性」（FR-002a）
- 未來日期：「您選擇的計費期間包含未來日期，是否確定?」（FR-010）

### 台電計價季節判定規則 _(mandatory)_

**夏月計價期間**:

- 起始日期：每年 6 月 1 日（含）
- 結束日期：每年 9 月 30 日（含）
- 判定邏輯：`if (month >= 6 && month <= 9) return "夏月"`

**非夏月計價期間**:

- 期間 1：每年 1 月 1 日（含）至 5 月 31 日（含）
- 期間 2：每年 10 月 1 日（含）至 12 月 31 日（含）
- 判定邏輯：`if (month >= 1 && month <= 5) || (month >= 10 && month <= 12) return "非夏月"`

**邊界日期處理**:

- 6 月 1 日：屬於夏月（包含）
- 9 月 30 日：屬於夏月（包含）
- 10 月 1 日：屬於非夏月（包含）
- 5 月 31 日：屬於非夏月（包含）

### Key Entities

完整術語定義請參考 `plan.md` 的 Terminology Glossary（中英對照與程式碼命名慣例）。

- **計費期間 (Billing Period)**: 使用者選擇的電費帳單計費區間，包含起始日期與結束日期，用於判定計價季節與作為歷史紀錄的時間軸基準
- **創建時間 (Created Timestamp)**: 系統自動產生的紀錄建立時間戳記，記錄使用者輸入資料並儲存的實際時間
- **計價季節 (Billing Season)**: 由計費期間自動判定的結果，值為「夏月」或「非夏月」，用於選擇對應的台電費率級距；若期間橫跨季節，以天數較多的季節為準
- **歷史紀錄 (History Record)**: 擴充現有的 Estimation Record 實體，新增計費期間欄位（起始與結束日期），保留原有的創建時間欄位

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 使用者選擇日期後，系統在 100 毫秒內自動判定並顯示對應的計價季節
- **SC-002**: 邊界日期（6/1、9/30、10/1、5/31）的計價季節判定準確率達 100%
- **SC-003**: 歷史紀錄表格的欄位標題清楚標示「計費期間」與「創建時間」，並在欄位標題旁提供工具提示（tooltip）說明差異：
  - 「計費期間」tooltip 完整文字：「電費帳單的實際計費區間（開始至結束日期）。例如：2024/07/01 - 2024/07/31 表示您電費帳單涵蓋的用電期間。」
  - 「創建時間」tooltip 完整文字：「您建立此筆估算紀錄的時間（可能與電費計費期間不同）。例如：您可能在 2024/10/09 回溯輸入 7 月份的帳單資料。」
  - 實作位置：HistoryTable 元件的 SortableTableHeader 中使用 HTML `title` 屬性或整合 Tooltip 元件（懸停 0.5 秒後顯示）
- **SC-004**: 歷史紀錄表格能流暢載入並顯示包含兩個時間欄位的 100 筆以上紀錄，載入時間不超過 2 秒
- **SC-005**: 使用者能在 3 次點擊內完成日期範圍篩選（開啟篩選器 → 選擇開始日期 → 選擇結束日期 → 套用）
- **SC-006**: 舊有歷史紀錄的資料遷移成功率達 100%，無資料遺失
- **SC-007**: 匯出的 CSV 檔案中，「用電日期」與「創建時間」欄位的格式符合規範，Excel 開啟後可正確識別為日期格式
- **SC-008**: 系統使用裝置本地時間記錄創建時間，時間戳記格式統一為 Unix timestamp (毫秒)，確保跨裝置的時間格式一致性

## Assumptions

### Domain Assumptions

- 台電的夏月/非夏月計價期間規則在未來數年內不會變動（6-9 月為夏月，其他月份為非夏月）
- 使用者輸入的電費帳單日期通常為實際繳費日期或帳單日期，不會刻意選擇錯誤的日期
- 農民主要關注月份層級的計價差異，不需要精確到小時或分鐘的計價判定
- 歷史紀錄的「用電日期」與「創建時間」可能相差數天甚至數月（例如農民回溯輸入過往帳單資料）

### User Assumptions

- 使用者理解「用電日期」指的是電費帳單的計價期間，而非實際抽水的日期
- 使用者能區分「用電日期」（帳單日期）與「創建時間」（輸入資料的時間）的不同用途
- 使用者在選擇日期時，會參考實際的電費帳單文件，而非憑記憶輸入
- 使用者可能需要回溯輸入過往數個月甚至一年前的帳單資料
- 使用者理解當電費帳單計費期間橫跨夏月與非夏月時，需要自行將帳單拆分為兩筆紀錄分別輸入，以確保計價準確性

### Technical Assumptions

- 應用程式使用的日期選擇器元件支援 YYYY-MM-DD 格式的日期輸入與顯示
- LocalStorage 有足夠空間儲存擴充後的歷史紀錄資料（包含額外的日期欄位）
- 瀏覽器的 Date 物件能正確處理台灣時區（GMT+8）的日期與時間
- 創建時間使用裝置本地時間，可能存在時間誤差（例如使用者手動調整裝置時間），系統接受此誤差
- 資料遷移腳本在應用程式載入時執行一次，不影響使用者體驗（執行時間少於 1 秒）

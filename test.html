<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台電電費反推用電度數 (表燈非營業用)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Inter 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* 避免 date input 在手機上的寬度問題 */
        input[type="date"] {
            min-width: 120px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg w-full max-w-lg">

        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-6">
            台電電費反推用電度數
        </h1>
        <p class="text-center text-gray-500 mb-6 text-sm">
            適用於「表燈非營業用」帳單
        </p>

        <div class="space-y-5">
            <!-- 輸入：流動電費 -->
            <div>
                <label for="billAmount" class="block text-sm font-medium text-gray-700 mb-1">
                    流動電費 (元)
                </label>
                <input type="number" id="billAmount" name="billAmount" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="請輸入帳單上的「流動電費」">
                <p class="mt-2 text-xs text-red-600 font-semibold">
                    **注意：** 請輸入「流動電費」，<strong class="font-bold">而非</strong>「應繳總金額」，因為節電獎勵無法反推。
                </p>
            </div>

            <!-- 輸入：計費期間 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">
                        計費期間 (起)
                    </label>
                    <input type="date" id="startDate" name="startDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">
                        計費期間 (迄)
                    </label>
                    <input type="date" id="endDate" name="endDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- 執行按鈕 -->
            <button id="calculateButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
                開始推算
            </button>
        </div>

        <!-- 結果顯示區 -->
        <div id="resultContainer" class="mt-8 pt-6 border-t border-gray-200 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">推算結果：</h2>

            <div class="bg-blue-50 p-5 rounded-xl border border-blue-200">
                <p class="text-sm text-blue-700 mb-2">預估總用電度數 (kWh)</p>
                <p id="resultKwh" class="text-4xl font-bold text-blue-900">
                    ---
                </p>
            </div>

            <div id="verificationContainer" class="mt-4 bg-gray-50 p-4 rounded-lg border border-gray-200 text-xs text-gray-600 space-y-2">
                <p id="verifyRateVersion"></p>
                <p id="verifyDays"></p>
                <p id="verifyBillCheck"></p>
            </div>
        </div>

        <!-- 錯誤訊息區 -->
        <div id="errorContainer" class="mt-6 text-center text-red-600 font-medium hidden">
            <p id="errorMessage"></p>
        </div>

    </div>

    <script>
        // --- 電價資料庫 (基於您提供的 JSON) ---
        // 我們將 "表燈非營業用" 的費率資料儲存在這裡
        const TAIPOWER_RATES = [
          {
            "version": "114年下半年 (2025-10-01 ~)",
            "effective_from": "2025-10-01",
            "effective_to": "9999-12-31",
            "type": "表燈非營業用",
            "summer": [
              { "limit": 120, "rate": 1.78 },
              { "limit": 330, "rate": 2.55 },
              { "limit": 500, "rate": 3.80 },
              { "limit": 700, "rate": 5.14 },
              { "limit": 1000, "rate": 6.44 },
              { "limit": Infinity, "rate": 8.86 }
            ],
            "non_summer": [
              { "limit": 120, "rate": 1.78 },
              { "limit": 330, "rate": 2.26 },
              { "limit": 500, "rate": 3.13 },
              { "limit": 700, "rate": 4.24 },
              { "limit": 1000, "rate": 5.27 },
              { "limit": Infinity, "rate": 7.03 }
            ]
          },
          {
            "version": "113年10月16日版 (2024-10-16 ~ 2025-09-30)",
            "effective_from": "2024-10-16",
            "effective_to": "2025-09-30",
            "type": "表燈非營業用",
            "summer": [
              { "limit": 120, "rate": 1.68 },
              { "limit": 330, "rate": 2.45 },
              { "limit": 500, "rate": 3.70 },
              { "limit": 700, "rate": 5.04 },
              { "limit": 1000, "rate": 6.24 },
              { "limit": Infinity, "rate": 8.46 }
            ],
            "non_summer": [
              { "limit": 120, "rate": 1.68 },
              { "limit": 330, "rate": 2.16 },
              { "limit": 500, "rate": 3.03 },
              { "limit": 700, "rate": 4.14 },
              { "limit": 1000, "rate": 5.07 },
              { "limit": Infinity, "rate": 6.63 }
            ]
          },
          {
            "version": "113年上半年 (2024-04-01 ~ 2024-10-15)",
            "effective_from": "2024-04-01",
            "effective_to": "2024-10-15",
            "type": "表燈非營業用",
            "summer": [
              { "limit": 120, "rate": 1.68 },
              { "limit": 330, "rate": 2.45 },
              { "limit": 500, "rate": 3.70 },
              { "limit": 700, "rate": 5.04 },
              { "limit": 1000, "rate": 6.24 },
              { "limit": Infinity, "rate": 8.46 }
            ],
            "non_summer": [
              { "limit": 120, "rate": 1.68 },
              { "limit": 330, "rate": 2.16 },
              { "limit": 500, "rate": 3.03 },
              { "limit": 700, "rate": 4.14 },
              { "limit": 1000, "rate": 5.07 },
              { "limit": Infinity, "rate": 6.63 }
            ]
          },
           {
            "version": "112年下半年 (2023-11-01 ~ 2024-03-31)",
            "effective_from": "2023-11-01",
            "effective_to": "2024-03-31",
            "type": "表燈非營業用",
             "summer": [
              { "limit": 120, "rate": 1.63 },
              { "limit": 330, "rate": 2.38 },
              { "limit": 500, "rate": 3.52 },
              { "limit": 700, "rate": 4.80 },
              { "limit": 1000, "rate": 5.83 },
              { "limit": Infinity, "rate": 7.69 }
            ],
            "non_summer": [
              { "limit": 120, "rate": 1.63 },
              { "limit": 330, "rate": 2.10 },
              { "limit": 500, "rate": 2.89 },
              { "limit": 700, "rate": 3.94 },
              { "limit": 1000, "rate": 4.74 },
              { "limit": Infinity, "rate": 6.03 }
            ]
          }
        ];

        // --- 核心邏輯 ---

        /**
         * 1. 根據「計費迄日」取得適用的電價版本
         * (根據我們的分析，台電似乎是用「計費迄日」或「抄表日」來決定適用費率)
         */
        function getRateVersion(periodEndStr) {
            const endDate = new Date(periodEndStr);
            // 從最新版本開始檢查
            for (const version of TAIPOWER_RATES) {
                const from = new Date(version.effective_from);
                const to = new Date(version.effective_to);
                if (endDate >= from && endDate <= to) {
                    return version;
                }
            }
            // 如果找不到，可能日期太舊，回傳 null
            return null;
        }

        /**
         * 2. 將「每月」級距轉換為「雙月」級距
         * 輸入: [ { limit: 120, rate: 1.68 }, { limit: 330, rate: 2.45 }, ... ]
         * 輸出: [ { kwh: 240, rate: 1.68 }, { kwh: 420, rate: 2.45 }, ... ]
         */
        function getBimonthlyTiers(monthlyTiers) {
            let bimonthlyTiers = [];
            let lastLimit = 0;
            for (const tier of monthlyTiers) {
                const kwhInTier = (tier.limit - lastLimit) * 2;
                bimonthlyTiers.push({ kwh: kwhInTier, rate: tier.rate });
                lastLimit = tier.limit;
                if (tier.limit === Infinity) {
                    break; // 到達無限大級距，停止
                }
            }
            return bimonthlyTiers;
        }

        /**
         * 3. 計算夏月/非夏月天數
         */
        function getSeasonalSplit(periodStartStr, periodEndStr) {
            const startDate = new Date(periodStartStr);
            const endDate = new Date(periodEndStr);

            let summerDays = 0;
            let nonSummerDays = 0;
            let totalDays = 0;

            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const year = currentDate.getFullYear();
                // 夏月定義：6月1日至9月30日
                const summerStart = new Date(year, 5, 1); // 6月 (JS 月份 0-11)
                const summerEnd = new Date(year, 8, 30, 23, 59, 59); // 9月

                if (currentDate >= summerStart && currentDate <= summerEnd) {
                    summerDays++;
                } else {
                    nonSummerDays++;
                }
                totalDays++;
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return { summerDays, nonSummerDays, totalDays };
        }

        /**
         * 4. [正向計算] 根據用電度數和期間，計算流動電費
         * 這是反向推算的基礎
         */
        function calculateBillFromKwh(totalKwh, periodStartStr, periodEndStr) {
            // 1. 取得電價版本
            const rateVersion = getRateVersion(periodEndStr);
            if (!rateVersion) {
                throw new Error(`找不到適用於 ${periodEndStr} 的電價版本。`);
            }

            // 2. 取得季節天數
            const { summerDays, nonSummerDays, totalDays } = getSeasonalSplit(periodStartStr, periodEndStr);
            if (totalDays === 0) return 0;

            // 3. 取得雙月級距
            const summerTiers = getBimonthlyTiers(rateVersion.summer);
            const nonSummerTiers = getBimonthlyTiers(rateVersion.non_summer);

            // 4. 分別計算「純夏月」和「純非夏月」的電費
            let totalSummerCost = 0;
            let totalNonSummerCost = 0;
            let kwhRemainingSummer = totalKwh;
            let kwhRemainingNonSummer = totalKwh;

            for (const tier of summerTiers) {
                const kwhInThisTier = Math.min(kwhRemainingSummer, tier.kwh);
                totalSummerCost += kwhInThisTier * tier.rate;
                kwhRemainingSummer -= kwhInThisTier;
                if (kwhRemainingSummer <= 0) break;
            }

            for (const tier of nonSummerTiers) {
                const kwhInThisTier = Math.min(kwhRemainingNonSummer, tier.kwh);
                totalNonSummerCost += kwhInThisTier * tier.rate;
                kwhRemainingNonSummer -= kwhInThisTier;
                if (kwhRemainingNonSummer <= 0) break;
            }

            // 5. 按天數比例混合計算
            const finalBill = (totalSummerCost * summerDays / totalDays) + (totalNonSummerCost * nonSummerDays / totalDays);

            return finalBill;
        }

        /**
         * 5. [反向推算] 根據流動電費和期間，找出用電度數
         * 使用二分搜尋法 (Binary Search)
         */
        function findKwhFromBill(targetBill, periodStartStr, periodEndStr) {
            let minKwh = 0;
            let maxKwh = 20000; // 設定一個合理的上限 (2萬度)
            let estimatedKwh = 0;
            let calculatedBill = 0;
            const precision = 0.01; // 誤差允許在 0.01 元 (1分錢) 內
            let iterations = 0;
            const maxIterations = 100; // 防止無限迴圈

            while (iterations < maxIterations) {
                estimatedKwh = (minKwh + maxKwh) / 2;

                calculatedBill = calculateBillFromKwh(estimatedKwh, periodStartStr, periodEndStr);

                const difference = calculatedBill - targetBill;

                // 檢查是否足夠接近
                if (Math.abs(difference) < precision) {
                    return estimatedKwh; // 找到了！
                }

                if (difference < 0) {
                    // 算出的電費太低 -> 實際用電度數更高
                    minKwh = estimatedKwh;
                } else {
                    // 算出的電費太高 -> 實際用電度數更低
                    maxKwh = estimatedKwh;
                }
                iterations++;
            }

            // 如果迴圈結束還沒找到精確解，回傳目前最接近的估計值
            return estimatedKwh;
        }

        // --- 事件監聽 ---
        const calculateButton = document.getElementById('calculateButton');
        const billAmountEl = document.getElementById('billAmount');
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');

        const resultContainer = document.getElementById('resultContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');

        const resultKwh = document.getElementById('resultKwh');
        const verificationContainer = document.getElementById('verificationContainer');
        const verifyRateVersion = document.getElementById('verifyRateVersion');
        const verifyDays = document.getElementById('verifyDays');
        const verifyBillCheck = document.getElementById('verifyBillCheck');

        calculateButton.addEventListener('click', () => {
            // 1. 清空上次結果
            resultContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            errorMessage.textContent = '';

            // 2. 獲取並驗證輸入
            const billAmount = parseFloat(billAmountEl.value);
            const startDate = startDateEl.value;
            const endDate = endDateEl.value;

            if (isNaN(billAmount) || billAmount <= 0) {
                errorMessage.textContent = '請輸入有效的「流動電費」金額。';
                errorContainer.classList.remove('hidden');
                return;
            }
            if (!startDate || !endDate) {
                errorMessage.textContent = '請輸入完整的「計費期間」。';
                errorContainer.classList.remove('hidden');
                return;
            }
            if (new Date(endDate) < new Date(startDate)) {
                errorMessage.textContent = '「計費迄日」不能早於「計費起日」。';
                errorContainer.classList.remove('hidden');
                return;
            }

            try {
                // 3. 執行反向推算
                const estimatedKwh = findKwhFromBill(billAmount, startDate, endDate);

                // 4. 顯示結果
                resultKwh.textContent = estimatedKwh.toFixed(1); // 顯示到小數點後 1 位

                // 5. 顯示驗證資訊
                const rateVersion = getRateVersion(endDate);
                const { summerDays, nonSummerDays, totalDays } = getSeasonalSplit(startDate, endDate);
                // 再次正向計算以驗證
                const billCheck = calculateBillFromKwh(estimatedKwh, startDate, endDate);

                verifyRateVersion.textContent = ` tasso 適用電價：${rateVersion.version}`;
                verifyDays.textContent = ` tasso 計費天數：共 ${totalDays} 天 (夏月 ${summerDays} 天 / 非夏月 ${nonSummerDays} 天)`;
                verifyBillCheck.textContent = ` tasso 驗證電費：${estimatedKwh.toFixed(4)} 度 算得電費為 ${billCheck.toFixed(2)} 元`;

                resultContainer.classList.remove('hidden');

            } catch (error) {
                // 捕捉計算過程中可能發生的錯誤 (例如找不到電價版本)
                errorMessage.textContent = `計算錯誤：${error.message}`;
                errorContainer.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>

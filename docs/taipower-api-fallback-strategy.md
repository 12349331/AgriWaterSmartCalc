# 台電 API 降級策略文件

**建立日期**: 2025-10-09
**版本**: 1.0
**狀態**: 已實作

---

## 概述

本文件說明當台電官方 API 無法連線時，系統如何透過多層降級策略確保應用程式仍能正常運作，提供可靠的電費轉用電量計算功能。

---

## 降級策略層級

系統採用 **4 層降級策略**，依優先順序如下：

### 第 1 層：台電官方 API（最高優先）✅

- **資料來源**: `https://service.taipower.com.tw/data/opendata/apply/file/d007008/001.json`
- **更新頻率**: 即時（台電官方維護）
- **精確度**: ⭐⭐⭐⭐⭐ 最高
- **快取策略**: 成功取得後快取 24 小時
- **連線逾時**: 5 秒
- **標記**: `pricingDataSource = 'api'`

**優點**:

- 資料最新、最準確
- 包含所有用電類型與級距
- 反映最新電價調整

**失敗情境**:

- 網路斷線
- CORS 限制（開發環境）
- API 伺服器維護
- 連線逾時（>5 秒）

---

### 第 2 層：本地完整電價資料（推薦）🔥

- **資料來源**: `src/data/001_updated.json`
- **更新頻率**: 手動更新（跟隨台電公告）
- **精確度**: ⭐⭐⭐⭐⭐ 最高（與官方 API 同等）
- **資料涵蓋**:
  - 表燈非營業用（夏月/非夏月）
  - 表燈營業用（夏月/非夏月）
  - 住宅用（夏月/非夏月）
  - 包含所有累進級距
- **標記**: `pricingDataSource = 'local'`

**轉換邏輯**:

```javascript
// src/data/taipowerDataConverter.js
export function convertTaipowerData() {
  // 從 001_updated.json 的原始格式
  // 轉換為應用程式標準格式
  {
    用電種類: "表燈非營業用",
    計費月份: "夏月",
    級距: "120度以下",
    單價: "1.78"
  }
}
```

**優點**:

- **完整性**: 包含所有官方定價資料
- **可靠性**: 不依賴網路連線
- **精確性**: 與官方 API 同等精確度
- **快速**: 本地載入，無網路延遲

**何時使用**:

- 台電 API 連線失敗
- 開發/測試環境（避免 CORS）
- 離線使用情境

---

### 第 3 層：LocalStorage 快取 🗂️

- **資料來源**: 瀏覽器 LocalStorage
- **更新頻率**: 由第 1 或第 2 層成功取得後自動更新
- **精確度**: ⭐⭐⭐⭐ 取決於快取來源
- **有效期限**: 24 小時
- **儲存鍵值**:
  - `aquametrics_taipower_pricing`
  - `aquametrics_pricing_timestamp`
- **標記**: `pricingDataSource = 'cache'`

**快取邏輯**:

```javascript
// 檢查快取有效性
const cacheAge = Date.now() - pricingCacheTimestamp;
const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 小時

if (cacheAge < CACHE_TTL && taipowerPricing.length > 0) {
  return taipowerPricing; // 使用快取
}
```

**優點**:

- 減少 API 請求次數
- 提升載入速度
- 短期離線可用

**限制**:

- 僅保留 24 小時
- 依賴瀏覽器儲存功能
- 清除瀏覽器資料會遺失

---

### 第 4 層：簡化備援資料（最後手段）⚠️

- **資料來源**: `src/data/taipowerFallback.js`
- **更新頻率**: 程式碼更新時手動維護
- **精確度**: ⭐⭐⭐ 簡化版（僅核心級距）
- **資料涵蓋**:
  - 表燈非營業用（夏月/非夏月）
  - 表燈營業用（夏月/非夏月）
  - **級距較少**（僅 6 個主要級距）
- **標記**: `pricingDataSource = 'fallback'`

**簡化範例**:

```javascript
// 僅包含主要級距，精確度較低
export const fallbackPricingData = [
  {
    用電種類: "表燈非營業用",
    計費月份: "非夏月",
    級距: "120度以下",
    單價: "1.63",
  },
  {
    用電種類: "表燈非營業用",
    計費月份: "非夏月",
    級距: "121-330度",
    單價: "2.38",
  },
  // ... 更少級距
];
```

**何時使用**:

- 所有其他層級都失敗
- 本地完整資料損壞
- LocalStorage 無法使用
- 網路長時間斷線

**警告訊息**:

```
⚠️ 使用簡化備援定價資料 (精確度較低)
```

---

## 降級流程圖

```
使用者請求計算
    ↓
檢查記憶體快取（< 24h）
    ├─ 有效 → 使用快取 [cache]
    └─ 無效/不存在 → 繼續
         ↓
嘗試台電官方 API（5s timeout）
    ├─ 成功 → 儲存快取 → 返回 [api] ✅
    └─ 失敗 → 繼續
         ↓
嘗試載入本地完整資料 (001_updated.json)
    ├─ 成功 → 儲存快取 → 返回 [local] 🔥
    └─ 失敗 → 繼續
         ↓
檢查 LocalStorage 快取
    ├─ 存在 → 返回 [cache] 🗂️
    └─ 不存在 → 繼續
         ↓
使用簡化備援資料
    └─ 返回 [fallback] ⚠️
```

---

## 使用者介面呈現

系統會在計算結果卡片中顯示資料來源提示：

### 使用本地完整資料

```
ℹ️ 使用本地完整電價資料
```

### 使用快取資料

```
ℹ️ 使用快取電價資料（24 小時內有效）
```

### 使用簡化備援資料

```
⚠️ 使用簡化電價資料（台電 API 無法連線）
```

### 使用官方 API（不顯示）

- 當成功從台電 API 取得時，不顯示提示（預設情況）

---

## Console 日誌範例

### 正常情境（API 成功）

```
🔄 嘗試從台電 API 取得定價資料...
✅ 成功從台電 API 取得定價資料
```

### 降級情境（使用本地資料）

```
🔄 嘗試從台電 API 取得定價資料...
⚠️ 台電 API 連線失敗: HTTP 500
🔄 嘗試使用本地完整定價資料 (001_updated.json)...
✅ 成功載入本地完整定價資料，共 36 筆
```

### 初始化日誌

```
✅ 初始化：載入本地完整定價資料
```

---

## 維護指南

### 1. 更新本地完整資料（推薦每季）

當台電公告電價調整時：

1. 取得最新的台電定價表格（Excel/JSON）
2. 更新 `src/data/001_updated.json`
3. 測試轉換邏輯：
   ```bash
   npm run test -- taipowerDataConverter
   ```
4. 驗證級距數量與單價正確

### 2. 更新簡化備援資料（選用）

若需更新 `src/data/taipowerFallback.js`：

1. 僅更新主要級距單價（6 個級距）
2. 保持資料結構一致
3. 測試計算邏輯

### 3. 監控資料來源分佈

在 Console 中觀察日誌：

- 若頻繁看到 `[fallback]`，需檢查網路或 API 狀態
- 若頻繁看到 `[local]`，表示 API 可能長期異常

---

## 測試案例

### TC01: 台電 API 正常

**前置條件**: 網路連線正常
**預期結果**: `pricingDataSource = 'api'`
**驗證**: Console 顯示「成功從台電 API 取得定價資料」

### TC02: API 失敗，本地資料可用

**前置條件**: 模擬 API 失敗，`001_updated.json` 存在
**預期結果**: `pricingDataSource = 'local'`
**驗證**: Console 顯示「成功載入本地完整定價資料」

### TC03: 所有資料來源失敗

**前置條件**: API 失敗、本地檔案損壞、快取清空
**預期結果**: `pricingDataSource = 'fallback'`
**驗證**: UI 顯示「⚠️ 使用簡化電價資料」

### TC04: 快取有效

**前置條件**: 24 小時內曾成功取得資料
**預期結果**: `pricingDataSource = 'cache'`
**驗證**: 不發送 API 請求

---

## 效能指標

| 層級     | 平均載入時間 | 資料量 | 精確度 |
| -------- | ------------ | ------ | ------ |
| API      | 500-2000ms   | 完整   | 100%   |
| Local    | <50ms        | 完整   | 100%   |
| Cache    | <10ms        | 完整   | 100%   |
| Fallback | <10ms        | 簡化   | ~90%   |

---

## 已知限制

1. **本地資料需手動更新**: `001_updated.json` 不會自動同步台電最新資料
2. **快取無法跨裝置**: LocalStorage 僅存在於單一瀏覽器
3. **簡化資料精確度較低**: Fallback 資料僅涵蓋主要級距

---

## 相關需求

- **FR-002a**: 系統 MUST 從台電 API 取得定價並快取 24 小時
- **CHK091**: 台電 API 失敗時的降級策略需求
- **CHK121-125**: API 依賴風險檢查項目

---

## 變更歷史

| 日期       | 版本 | 變更內容                    |
| ---------- | ---- | --------------------------- |
| 2025-10-09 | 1.0  | 初始版本，實作 4 層降級策略 |

---

**維護負責人**: 開發團隊
**審查週期**: 每季或台電電價調整時
